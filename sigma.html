<html>

<head>
  <title>ProgVIZ</title>
  <link rel="stylesheet" href="sigma.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Importing w3.css -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <!-- Importing w3.js -->
  <script src="https://www.w3schools.com/lib/w3.js"></script>

  <!-- Importing icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- START SIGMA IMPORTS -->
  <script src="sigma_lib/src/sigma.core.js"></script>
  <script src="sigma_lib/src/conrad.js"></script>
  <script src="sigma_lib/src/utils/sigma.utils.js"></script>
  <script src="sigma_lib/src/utils/sigma.polyfills.js"></script>
  <script src="sigma_lib/src/sigma.settings.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.dispatcher.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.configurable.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.graph.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.camera.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.quad.js"></script>
  <script src="sigma_lib/src/classes/sigma.classes.edgequad.js"></script>
  <script src="sigma_lib/src/captors/sigma.captors.mouse.js"></script>
  <script src="sigma_lib/src/captors/sigma.captors.touch.js"></script>
  <script src="sigma_lib/src/renderers/sigma.renderers.canvas.js"></script>
  <script src="sigma_lib/src/renderers/sigma.renderers.webgl.js"></script>
  <script src="sigma_lib/src/renderers/sigma.renderers.svg.js"></script>
  <script src="sigma_lib/src/renderers/sigma.renderers.def.js"></script>
  <script src="sigma_lib/src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
  <script src="sigma_lib/src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
  <script src="sigma_lib/src/renderers/webgl/sigma.webgl.edges.def.js"></script>
  <script src="sigma_lib/src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
  <script src="sigma_lib/src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
  <script src="sigma_lib/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.utils.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.nodes.def.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.edges.def.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.edges.curve.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.labels.def.js"></script>
  <script src="sigma_lib/src/renderers/svg/sigma.svg.hovers.def.js"></script>
  <script src="sigma_lib/src/middlewares/sigma.middlewares.rescale.js"></script>
  <script src="sigma_lib/src/middlewares/sigma.middlewares.copy.js"></script>
  <script src="sigma_lib/src/misc/sigma.misc.animation.js"></script>
  <script src="sigma_lib/src/misc/sigma.misc.drawHovers.js"></script>
  <script src="sigma_lib/src/misc/sigma.misc.bindEvents.js"></script>
  <script src="sigma_lib/src/misc/sigma.misc.bindDOMEvents.js"></script>

  <!-- END SIGMA IMPORTS -->
  <script src="sigma_lib/plugins/sigma.renderers.edgeLabels/settings.js"></script>
  <script src="sigma_lib/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>
  <script src="sigma_lib/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
  <script src="sigma_lib/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
  <script src="sigma_lib/plugins/sigma.layout.forceAtlas2/worker.js"></script>
  <script src="sigma_lib/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>
  <script src="sigma_lib/plugins/sigma.layouts.dagre/sigma.layout.dagre.js"></script>
  <script src="bower_components/dagre/dist/dagre.core.min.js"></script>

</head>

<body>

  <div id="main">
    <div class="w3-cell-row">
      <div class="w3-container w3-cell" id="essentials">
        <div class="icons"><i class="fa fa-search icons"></i></div>
        <div class="icons"><i class="glyphicon glyphicon-zoom-in icons"></i></div>
        <div class="icons"><i class="glyphicon glyphicon-zoom-out icons"></i></div>
      </div>

      <div class="w3-container w3-cell" id="graphContainer">
        <p>Welcome to progVIZ</p>
      </div>

      <div class="w3-container w3-cell" id="graphProperties">
        <h5 class="header">Graph Properties
          &nbsp&nbsp<i class="fa fa-close" onclick="w3.hide('#graphProperties');
          w3.addStyle('#graphContainer', 'width', '720px');"></i>
        </h5>
        <ul>
          <li>Name</li>
          <li>Nodes</li>
          <li>Edges</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- <div id="container"></div> -->





  <script>
    function startRead() {
      // obtain input element through DOM

      var file = document.getElementById('dotFile').files[0];
      if (file) {
        getAsText(file);
      }
    }

    function getAsText(readFile) {
      var reader;
      try {
        reader = new FileReader();
      } catch (e) {
        document.getElementById('container').innerHTML =
          "Error: seems File API is not supported on your browser";
        return;
      }

      // Read file into memory as UTF-8
      reader.readAsText(readFile, "UTF-8");

      // Handle progress, success, and errors
      reader.onprogress = updateProgress;
      reader.onload = loaded;
      reader.onerror = errorHandler;
    }

    function updateProgress(evt) {
      if (evt.lengthComputable) {
        // evt.loaded and evt.total are ProgressEvent properties
        var loaded = (evt.loaded / evt.total);
        if (loaded < 1) {
          // Increase the prog bar length
          // style.width = (loaded * 200) + "px";
        }
      }
    }

    function loaded(evt) {
      // Obtain the read file data
      var fileString = evt.target.result;
      creatJSONFile(fileString);


    }

    function errorHandler(evt) {
      if (evt.target.error.code == evt.target.error.NOT_READABLE_ERR) {
        // The file could not be read
        document.getElementById('container').innerHTML = "Error reading file..."
      }
    }


    var graph = {
      nodes: [],
      edges: []
    };



    function creatJSONFile(dotString) {

      lines = dotString.split("\n");

      var i = 2;
      var nodes = new Array();
      while (lines[i] != "") {

        var node_id, node_lable;
        var index = 3;

        while (lines[i].charAt(index) != " ")
          index++;

        node_id = lines[i].substr(3, index - 3);
        index += 11;
        node_lable = lines[i].substr(index, lines[i].length - index - 3);



        nodes.push({
          id: node_id,
          label: node_lable,
          x: 3,
          y: (i - 2) * 2,
          size: 20,
          color: '#666'
        });

        i++;
      }



      var edges = new Array();
      for (var j = i + 1; j < lines.length - 3; j++) {

        var source, target, edge_lable;
        var index = 3;

        while (lines[j].charAt(index) != " ")
          index++;



        source = lines[j].substr(3, index - 3);

        index += 4;


        var last_index = index;

        while (lines[j].charAt(index) != " " && lines[j].charAt(index) != ";")
          index++;

        target = lines[j].substr(last_index, index - last_index);

        var curEdge = {};

        var curEdge = {
          id: j,
          label: " ",
          source: source,
          target: target,
          size: 30,
          color: 'red',
          type: 'arrow'

        };

        if (lines[j].charAt(index) === " ") { // if edge has no lable
          index += 11;
          edge_lable = lines[j].substr(index, lines[j].length - index - 3);
          curEdge.label = edge_lable;
        }

        edges.push(curEdge);


      }


      graph.nodes = nodes;
      graph.edges = edges;


      drawGraph();

    }


    function drawGraph() {

      // Instantiate sigma:
      s = new sigma({
        graph: graph,
        renderer: {
          container: document.getElementById('graph-container'),
          type: 'canvas'
        },
      });

      //s.startForceAtlas2({worker: true, barnesHutOptimize: false});
      var config = {
        rankdir: 'TB'
      };

      // Start the algorithm:
      var listener = sigma.layouts.dagre.configure(s, config);

      sigma.layouts.dagre.start(s);


    }
  </script>

</body>

</html>